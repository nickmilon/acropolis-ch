<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    
    <link rel="icon" href="resources/images/favicon.ico" />
    

    <!-- Adding meta -->
    
    
    <meta name="Author" content="@NickMilon" />
    
    <meta name="Description" content="a Node js HTTP client for clickhouse" />
    
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    
    
    <link type="text/css" rel="stylesheet" href="docs.css">
    
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.0/css/OverlayScrollbars.min.css"
      integrity="sha512-pYQcc5kgavar0ah58/O8hw/6Tbo3mWlmQTmvoi1i96cBz7jQYS9as5J+Nfy32rAHY6CgR9ExwnFMcBdGVcKM7g=="
      crossorigin="anonymous" />
    


    <title>
      Home
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <h2><a href="index.html"><p class='nm-topHeader'>acropolis-ch js http client for: <a href='https://clickhouse.com' target= '_blank'><img src='./resources/images/clickhouse.svg' alt='clickhouse.com' height=14>clickhouse</a></p></a></h2><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><ul><li class="menu-li"><a href='https://github.com/nickmilon/acropolis-ch' class=' menu-link' id='github' target='_blank'>github</a></li><li class="menu-li"><a href='https://www.npmjs.com/package/acropolis-ch' class=' menu-link' id='npm' target='_blank'>npm</a></li><li class="menu-li"><a href='https://nickmilon.github.io/acropolis-ch/' class=' menu-link' id='' target='_blank'>website</a></li></ul><div class="accordion collapsed" id="5715253" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="module-clientDel2.html">clientDel2</a></li></ul> </div><div class="accordion collapsed" id="1673176" > <h3 class="accordion-heading">Classes<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="module-clientDel2.CHclient.html">CHclient</a></li></ul> </div>
      
        <div class="navbar-resize" id="navbar-resize">
          <div class="resize-dots-container">
            <div class="dots"></div>
            <div class="dots"></div>
            <div class="dots"></div>
          </div> 
        </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      

      



    









    


    <section class="readme">
        <article><h1>acropolis-ch</h1>
<p>Node js HTTP client for:¬†
<a href="https://clickhouse.com" target= "_blank">
<img src="./resources/images/clickhouse.svg" alt="clickhouse.com" height=14>¬†¬†clickhouse
</a>
using <a href="https://undici.nodejs.org/">undici</a> http library.</p>
<hr>
<h2>Why</h2>
<p>Although there are already a few <a href="https://clickhouse.com/docs/en/interfaces/third-party/client-libraries/">js libraries for Clickhouse</a>,
we decided to write this one from scratch, reasons been among others:</p>
<ul>
<li>Existing libs couldn't cover the needs for the project that this library was written for  where performance was a paramount requirement.</li>
<li>As clickhouse has quite a few idiosyncrasies compared to classic sql we needed something more than a plain driver in order to make
onboarding easy for developers.</li>
<li>Node's native standard http library is quite problematic with a huge back-log of issues and performance is not optimal.
Node team is thinking of retiring it and probably replace/substitute it with undici which is already under <a href="https://twitter.com/matteocollina/status/1298148085210775553?lang=en">Node's organization umbrella</a>.</li>
</ul>
<h2>Conventions - Design - Features:</h2>
<ul>
<li>Library only supports ESM modules (imports) commonjs (require) is not supported, If you need commonjs support feel free to fork the library or transpile it somehow to commonjs.<br></li>
<li>Supports connection pools and input/output streams out of the box.</li>
<li>Library follows a minimalist design you only have to understand just one method (request) from a single class in order to start using it.</li>
<li>Batteries are included and gradually covers more developer needs by providing utilities for common tasks and caters for future needs
and particular use cases by providing expandable building blocks. Also we try to adhere to best practices with usage examples and code in tests.</li>
<li>
<h3>Dependencies:</h3>
There are no dependencies except undici and <a href="https://github.com/nickmilon/acropolis-nd">acropolis-nd</a> a tiny utilities lib.</li>
<li>
<h3>Security - sql injections:</h3>
Library doesn't attempt to safeguard against sql injections, to mitigate against those threats you can:
<ul>
<li>sterilize your queries beforehand.</li>
<li>use prepared queries (views).</li>
<li>use parameterized queries.</li>
</ul>
</li>
</ul>
<h2>License: <a href="./LICENSE">Apache</a></h2>
<h1>Quick start:</h1>
<ul>
<li>
<h2>installation:</h2>
<p><code>npm install acropolis-ch --save</code></p>
<h3>check installation and clickhouse connectivity:</h3>
<p><code>cd yourInstallationFolder/node_modules/acropolis-ch/</code><br>
<em>edit const confCH in ./scripts/usage.js to reflect your clickhouse url and credentials</em><br>
<code>npm run usageREPL</code> to check installation and connection to clickhouse http server<br>
<em>check output for errors or warnings</em><br></p>
</li>
<li>
<h2>basic usage:</h2>
</li>
</ul>
<hr>
<!--usageStart-->
<pre class="prettyprint source lang-js"><code>
/**
...  * @summary: usage example ü§Ø
...  * This is a script modified to run under Node's REPL to produce a usage.md file
...  * therefore it contains some strange syntax that should be not used in a normal module in particular:
...  * 1) sometimes uses 'var' for declarations instead of const and/or let
...  * 2) uses dynamic imports (a function) in place of import statements as in JS modules.
...  * ‚ùóÔ∏èSo you will have to adjust for those if you reuse part of this code
...  */
// üëá‚ùóÔ∏èin your modules replace with: import { CHclient, ...  } from 'acropolis-ch'
‚û°Ô∏è const { CHclient, flagsCH, createContext, formatStr } = await import(`${impDir}/index.js`)
// üëájust for easy client configuration (provide your parameters here)
‚û°Ô∏è const confCH = { uri: 'http://localhost:8123', credentials: { user: 'default', password: 'nickmilon' } };
// üëácreate client instance with given parameters
‚û°Ô∏è const client = new CHclient(confCH.uri, confCH.credentials, { connections: 10 });

// üëá check ping CH server  üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•üö•
‚û°Ô∏è result = await client.ping() // üëà ping CH server
‚û°Ô∏è result.statusCode // ‚úÖ statusCode should always be 200 if all ok and CH server is reachable no error even if credentials are wrong
200
‚û°Ô∏è result = await client.request('SELECT * FROM numbers(1, 3) FORMAT JSON') // üëà run a CH query
{
  statusCode: 200,
  headers: {
    date: 'Sat, 12 Feb 2022 09:40:17 GMT',
    connection: 'Keep-Alive',
    'content-type': 'application/json; charset=UTF-8',
    'x-clickhouse-server-display-name': 'Y720',
    'transfer-encoding': 'chunked',
    'x-clickhouse-query-id': '4048dd6b-49b1-4f8d-b54f-3ed2e5d0b8c0',
    'x-clickhouse-format': 'JSON',
    'x-clickhouse-timezone': 'Europe/Athens',
    'keep-alive': 'timeout=3',
    'x-clickhouse-summary': '{&quot;read_rows&quot;:&quot;0&quot;,&quot;read_bytes&quot;:&quot;0&quot;,&quot;written_rows&quot;:&quot;0&quot;,&quot;written_bytes&quot;:&quot;0&quot;,&quot;total_rows_to_read&quot;:&quot;0&quot;}',
    'x-acropolis-dtEnd': 2022-02-12T09:40:17.341Z
  },
  trailers: {},
  body: {
    meta: [ { name: 'number', type: 'UInt64' } ],
    data: [ { number: '1' }, { number: '2' }, { number: '3' } ],
    rows: 3,
    rows_before_limit_at_least: 3,
    statistics: { elapsed: 0.000206268, rows_read: 3, bytes_read: 24 }
  }
}
‚û°Ô∏è if (result.statusCode === 403 && statusCodePing === 200 ) {  stdoutMsg(`‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏èCH http server responds but probably your credentials are wrong\n ${result.body}`); }  // {{DE>>>if (result.statusCode === 403 && statusCodePing === 200 ) {  stdoutMsg(`‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏èCH http server responds but probably your credentials are wrong\n ${result.body}`); }  // {{DEL }}

/**
...  * @summary: CH query demoüö¶ü§Ø
...  * All queries to ch are async and return an object { statusCode, body, headers, trailers} when resolved
...  * You can read more about client flags in library docs.
...  * body can be a string or json or a promise depending on some flag settings and CH format used
...  */
‚û°Ô∏è var { statusCode, result, body, headers } = await client.request('SELECT * FROM numbers(1, 3) FORMAT CSV');
‚û°Ô∏è body; // üëá body now is a text because we changed CH format to CSV
'1\n2\n3\n'
‚û°Ô∏è result = await client.request('DROP TABLE IF EXISTS default.usage1');
‚û°Ô∏è result = await client.request('DROP TABLE usage1');
‚û°Ô∏è result.statusCode; // üëá statusCode returned by CH is 404 since table doesn't exist as we dropped it already if existed
404
‚û°Ô∏è result.body; // üëá body contains verbose info for the error
&quot;Code: 60. DB::Exception: Table default.usage1 doesn't exist. (UNKNOWN_TABLE) (version 22.1.3.7 (official build))\n&quot;

/**
...  * @summary: ‚ÑπÔ∏èüíÅcontext usage
...  * context simplifies sql statement execution by presetting client and CH options and support of intellisense typing
...  * in some editors. Also can be easily extended to support user specific sql queries.
...  * Following line creates a client context where flags do not specify flag 'resolve' so body returned by any query 
...  * that uses this context will be a stream
...  */
‚û°Ô∏è ctxStream = createContext(client, { chOpts: {}, flags: flagsCH.flagsToNum(['throwNon200']) });
// üëá create an other client context that resolves body and specifies a clickhouse option
‚û°Ô∏è ctxResolve = createContext(client, { chOpts: { output_format_json_quote_64bit_integers: 0 }, flags: flagsCH.flagsToNum(['resolve']) });
‚û°Ô∏è result = await ctxStream.CREATE_TABLE_fromSchema('default', 'usage1', '(number UInt64)', { ENGINE: 'MergeTree ORDER BY number' });
‚û°Ô∏è result = await ctxStream.SELECT('*', { FROM: 'numbers(1, 100000)', FORMAT: formatStr.CSV}); //  specify format by formatsStr for convenience
‚û°Ô∏è [typeof result.body, typeof result.body._read ] // üëà since context flags does not specify flag 'resolve' body will be a readable stream
[ 'object', 'function' ]

// üëá inserting into table usage1 body the stream of previous SELECT 
‚û°Ô∏è result = await ctxStream.INSERT_INTO('default', 'usage1', result.body, {FORMAT: 'CSV'}) // üëà inserting into table usage1 body stream of previous SELECT 
‚û°Ô∏è result = await ctxResolve.SELECT('count(*) as count', { FROM: 'default.usage1', FORMAT: formatStr.JSONEachRow});
‚û°Ô∏è assert.equal(result.body.count, 100000 ); // üëà we just inserted 100K records from one table to an other ü§™ clickHouse is so fast 
‚û°Ô∏è result = await ctxResolve.DROP_TABLE('default', 'usage1');
‚û°Ô∏è assert.equal(result.statusCode, 200);
</code></pre>
<!--usageEnd-->
<ul>
<li>
<h2>more examples:<br></h2>
<ul>
<li><a href="__tests__">visit tests code</a></li>
<li>read library's docs</li>
</ul>
</li>
</ul>
<hr>
<h2>Testing:</h2>
<p>Almost full coverage tests are provided in <a href="__tests__">tests folder</a>. To run the tests you will need to install <a href="https://jestjs.io/">jest</a> and <br>
<code>npm run test </code><br>
Tests are also meant to demonstrate usage and best practices that's why plenty of output is provided on console during test runs.<br>
You can limit output verbosity by setting logLevel variable in /config.js to one of available levels.</p>
<h2>Disclosure</h2>
<ul>
<li>This project is in no way connected to official clickhouse or undici projects.</li>
<li>Library has been used in production without issues for quite some time, still we encourage to do your own testing/evaluation before using in production.</li>
</ul>
<h2>‚ùî Questions - Issues</h2>
<ul>
<li>For any suggestions, questions or bugs, feel free to create an <a href="https://github.com/nickmilon/acropolis-ch/issues">issue</a></li>
</ul>
<h2>üôè Acknowledgements:</h2>
<p>Many thanks to¬†¬†<a href="https://rapchat.com"><img src="./resources/rapchat.svg" alt="rapchat.com" height=14 target= "_blank"></a> for partially funding initial development of this project.</p>
<hr>
<h2>üìñ Awesome Resources and further reading:</h2>
<ul>
<li><a href="resources/awesome.md">see here</a></li>
</ul>
<hr></article>
    </section>






    </div>

    <footer class="footer" id="footer">
      Fork: <a href='https://github.com/nickmilon/acropolis-ch'>https://github.com/nickmilon/acropolis-ch</a>
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"clientDel2","link":"<a href=\"module-clientDel2.html\">clientDel2</a>"},{"title":"CHclient","link":"<a href=\"module-clientDel2.CHclient.html\">CHclient</a>"}];
        var options = {"shouldSort":true,"threshold":0.4,"location":0,"distance":100,"maxPatternLength":32,"minMatchCharLength":1}
          setupSearch(list, options)
      </script>
    

    

    
      <script src="scripts/resize.js"></script>
      <script type="text/javascript">
        var option = {"min":"300","max":"600"}
        setupResizeOptions(option)
      </script>
    

    


  </body>

</html>